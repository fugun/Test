<!DOCTYPE html>
<html class="x-admin-sm">
    
    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-X-admin</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <!--  <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />-->
        <link rel="stylesheet" href="../css/font.css">
        <link rel="stylesheet" href="../css/xadmin.css">
        <script src="../lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="../js/xadmin.js"></script>
        <script type="text/javascript" src="../js/jquery.min.js"></script>
        <script type="text/javascript" src="../js/iosiframe.js"></script>
        <!--[if lt IE 9]>
          <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
          <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    
    <body>
         <!-- <div class="x-nav">
            <span class="layui-breadcrumb">
                <a href="">首页</a>
                <a href="">演示</a>
                <a>
                    <cite>导航元素</cite></a>
            </span>
            
        </div>-->
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body ">
                            <form class="layui-form layui-col-space5">
                                <div class="layui-inline layui-show-xs-block">
                                    <input class="layui-input" autocomplete="off" placeholder="开始日" name="start" id="start"></div>
                                <div class="layui-inline layui-show-xs-block">
                                    <input class="layui-input" autocomplete="off" placeholder="截止日" name="end" id="end"></div>
                                <div class="layui-inline layui-show-xs-block">
                                    <input type="text" name="menuname" placeholder="菜单名" autocomplete="off" id = "menuname" class="layui-input"></div>
                                <div class="layui-inline layui-show-xs-block">
                                    <button class="layui-btn" lay-submit="" lay-filter="sreach" id ="sreach" >
                                        <i class="layui-icon">&#xe615;</i></button>
                                </div>
                                <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
						                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
						         </a>
                            </form>
                        </div>
                         
                         <!-- <input type="hidden" id="objCheckList" name="objCheckList" value=""/>  页面 保存多选id_当前状态_菜单权限组id_-->
                        <div class="layui-card-body ">
                        <table class="layui-table" id="LAY_table_user" lay-filter="tableAll"></table>
                           <!--  <table class="layui-table" lay-data="{url:'./json/find',page:true,toolbar: '#toolbarDemo',id:'tableAll'}" lay-filter="tableAll">
                                <thead>
                                    <tr style = "height:50px">
                                        <th lay-data="{type:'checkbox'}">id</th>
                                        <th lay-data="{field:'id', width:80, sort: true}">ID</th>
                                        <th lay-data="{field:'loginName', width:120, sort: true,templet: '#loginName'}">用户名</th>
                                        <th lay-data="{field:'status', width:120,templet: '#switchTpl'}">用户状态</th>
                                        <th lay-data="{field:'userId', width:120,templet: '#switchTplUser'}">添加状态</th>
                                        <th lay-data="{field:'experience', templet: '#operator'}">操作</th>-->
                                        <!-- <th lay-data="{field:'dw_xinzhi',templet: function(d){ return d.dw_xinzhi.titel;}}">学校</th>
                                        
                                   </tr>
                                </thead>
                            </table>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script type="text/html" id="toolbarDemo">
        <div class = "layui-btn-container" > 
			<button class="layui-btn" lay-event = "addAll"" ><i class="layui-icon"></i>批量添加</button>
         	
            <button class = "layui-btn layui-btn-sm" lay-event = "getCheckData" > 获取选中行数据 </button>
            <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button > 
            <button class = "layui-btn layui-btn-sm" lay-event = "isAll" > 验证是否全选</button>
        </div > 
		
          
    </script>
    
    <script type="text/html" id="loginName">
		<tb id = "statusUpLoginName">
		 <span>{{d.roleName!=null?d.roleName:''}}</span></tb>
        
    </script>
    <!--  <script type="text/html" id="checkboxOnclick">
		 <button class = "layui-btn layui-btn-sm" lay-event = "isAlls" ></button>
        
    </script>-->
   
     <script type="text/html" id="switchTplUser">
		<tb id = "statusUpUser">
		 <span class="layui-btn layui-btn-normal layui-btn-mini {{d.roleStatus==1?'':'layui-btn-disabled'}}" >{{d.roleStatus==1?'已添加':'未添加'}}</span></tb>
        
    </script>
    <script type="text/html" id="operator">
         
       <a title="编辑"  onclick="xadmin.open('编辑','update-appAccount.html?id={{d.id}}&validity={{d.validity}}&des={{d.des}}',600,600)" href="javascript:;">
             <i class="layui-icon">&#xe642;</i>
         </a> 
        
		 <a onclick="member_RoleStatus(this,{{d.id}})" href="javascript:;"  title="添加">
         	 <i class="layui-icon"></i>
         </a>    

                       
	</script>
    <script> 
   	    
    	layui.use('laydate', function(){
        	var laydate = layui.laydate;
       		 
            //执行一个laydate实例
            laydate.render({
                elem: '#start' //指定元素
                	,type: 'datetime'
            });

            //执行一个laydate实例
            laydate.render({
                elem: '#end' //指定元素
                	,type: 'datetime'
            });

        });</script>
    <script>
    var idlength  = "";  // 保存多选id  用于删除提示展示
    var page = 1;
    getTaskId()// 保任务id
    layui.use('table',
        function() {
            var table = layui.table;
            var loadi = layer.load('加载中......');
        	
          //方法级渲染
            table.render({
                elem: '#LAY_table_user'
                ,url: './find/appAccount'
                ,cols: [[
                     {field:'id',checkbox: true,templet: '#checkboxOnclick'},
                     {field:'id',title: 'ID', width:70, sort: true}, //用户id
                     {field:'userName', title : '帐户名',width:120, sort: true},
                     {field:'name', title:"商户",width:100},
                     //{field:'imei', title:"IMEI",edit: 'text', minWidth: 50},
                     {field:'model', title:"机型",width:70},
                     {field:'validity',title:"有效期时间", width:150,templet:function (d) {
                         return getLocalTime(d.validity);
                     }},
                         
                     {field:'grossIncome',title:"已提现金额", width:80},
                     {field:'withdrawable',title:"可提现金额", width:80},
                     {field:'createTime', title:"注册时间",width:150,templet:function (d) {
                         return getLocalTime(d.createTime);
                     }},
                     {field:'lastLoginTime', title:"登陆时间",width:150,templet:function (d) {
                         return getLocalTime(d.lastLoginTime);
                     }},                                      
                     {field:'experience', title:"操作",templet: '#operator'}
                ]]
                ,id: 'tableAll'
                ,page: true
                ,toolbar:'#toolbarDemo'
                ,where:{}
            });

            
        	layer.close(loadi);
            //监听单元格编辑
            table.on('edit(tableAll)',
            function(obj) {
                var value = obj.value //得到修改后的值
                ,
                data = obj.data //得到所在行所有键值
                ,
                field = obj.field; //得到字段
                layer.msg('[ID: ' + data.id + '] ' + field + ' 字段更改为：' + value);
            });
            //头工具栏事件
            table.on('toolbar(tableAll)',
            function(obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                var ids = "";          	   
        	    //console.log(idlength);
        	    str = idlength.split(",");
        	    if(idlength!=null && idlength!=""){
    	            //checkOnes[i].checked=false;
    	            for(var a= 0 ;str.length>a;a++){
    	       			if(str[a]!=null && str[a]!=""){
    	       				if(str[a].indexOf("-") == -1){
    	       					if(ids==""){	       	           		 
    	       						ids =str[a];
    	       			              //console.log(str[a]);
    	       			        }else{
    	       			        	ids = ids +","+ str[a];	       			           		 
    	       			        }
    	       				}
    	       		   }
    	        }
    	     }
        	    //console.log(ids);
                switch (obj.event) {
                case 'addAll':
                	//var ids = [];
                	//var id = [];
                	//var dataList = checkStatus.data;
                	//$.each(dataList, function(i, data) {
                		//console.log(data.id);
                		//ids.push(data.id);
                		//id.push(data.id+"_"+data.roleStatus+"_"+data.menuRoleId+"_");
                	//});
                	if(ids.length<1){
                     	layer.msg('请选择要添加的列!', {icon: 7});
                     	return false;
                     }
                    layer.confirm('确认要添加吗？'+ids,function(index){
                    	 
                    	var loadi = layer.load('加载中......');
                    	
                        //捉到所有被选中的，发异步
                        //发异步                         
	                    var url = "add/TaskRecordAddTask";
	                    var data ={
	                    		userId:ids,
	                    		taskId:getTaskId()               		
	                        };            
	                    $.ajax({
	                		url:url,
	                		data:data,
	                		type:'post',
	                		dataType:'json',
	                		success: function(result){
	                			//console.log(result.code);
	                			
                				layer.close(loadi);
	                			if(result.code==200){                				
	                				//发异步添加数据
	                				 layer.msg('添加成功', {icon: 1});
	                                 //$(".layui-form-checked").not('.header').parents('tr').remove();
	                                //清除数据
	                                 idlength  = "";  // 保存多选id  用于删除提示展示
   									 page = 1;
   								    // 重新刷新
	                                f5(table);
	                                
	                			}else{
	                				layer.alert(result.msg, {
	                                    icon: 7
	                                });
	                			}
	                			
	                		},
	                		error: function(e){
	                			//alert("通信失败!");
	                		}
	                	});
                       
                    });
                	break;
                case 'getCheckData':
                    var data = checkStatus.data;
                    layer.alert(JSON.stringify(data));
                    break;
                case 'getCheckLength':
                   // var data = checkStatus.data;
                  
                    layer.msg('选中了：' + ids.split(",").length + ' 个');
                    break;
                case 'isAll':
                    layer.msg(checkStatus.isAll ? '全选': '未全选');
                    break;
                };
            });
            
             $('#sreach').on('click', function() {
            		  f5(table);
	        		return false;
	          }); 
            
        		 // 第一步 获取name属性为luck值得对象数组(节点数组)   
                var luckElements =  document.getElementsByClassName("layui-table-header")                   
                        /*
                            第二步 遍历节点数组
                        */
                        for(var i=0;i<luckElements.length;i++){
                            //获取元素的value值
                           // alert(luckElements[i].value);
                            //获取元素的type值
                           // alert(luckElements[i].type);
                            //为每一个元素的onclick属性赋值即为文本框增加点击事件
                            luckElements[i].onclick=function(){
        			             setTimeout(function() {
        			            	 // 获取当前页面做拼接
        			            	  
        			            	 var checkStatus = table.checkStatus("tableAll");    	                 			  
                        				var ids = "";
                                    	var idList = "";
                                    	var dataList = checkStatus.data;
                                    	//console.log(dataList);
                                    	$.each(dataList, function(i, data) {
                                    		//console.log(data.id);
                                    	    ids = ids +","+ data.id;
                                    	   idList = idList +","+ data.id+"_"+data.roleStatus+"_"+data.menuRoleId+"_";
                                    	});
                                    	chakAdd(page,ids,idList)
        			             },  500);	
                            }
                        }
                
                var main =  document.getElementsByClassName("layui-table-body layui-table-main")
                        for(var i=0;i<main.length;i++){                        
        		              main[i].onclick=function(){
               	 			//console.log("fhu");
        		            	 setTimeout(function() {
        		            		
        			            	 var checkStatus = table.checkStatus("tableAll");    
        		         			  
        		         				var ids = [];
        		                     	var idList = [];
        		                     	var dataList = checkStatus.data;
        		                     	//console.log(dataList);
        		                     	$.each(dataList, function(i, data) {
                                    		//console.log(data.id);
                                    	    ids.push(data.id);
                                    		idList.push(data.id+"_"+data.roleStatus+"_"+data.menuRoleId+"_");
                                    	});
                                    	chakAdd(page,ids,idList)
        			             },  100);	
                    			}
                        }
                
                // 绑定分页
                var table_page =  document.getElementsByClassName("layui-table-page")
                        for(var i=0;i<table_page.length;i++){                       
        		              table_page[i].onclick=function(){
               	 				// 给点击页给值 
               	 				page = $("#pageId").val();
               	 				//console.log(page);
        		            	 setTimeout(function() {
        		            		 // 设置选中项
        		            		 chak();
        			             },  100);	
                    			}
                        }
                
                
        	
    });       
            
 	// 刷新查询
	function f5(table){
    	var loadi = layer.load('加载中......');
    	
    	table.reload('tableAll', {
			method : 'post',
			where : {
				menuname : $('#menuname').val(),
				start:$("#start").val(),
				end:$("#end").val()
			},
			page : {
				curr : 1
			}
		});
    	
    	 // 第一步 获取name属性为luck值得对象数组(节点数组)   
        var luckElements =  document.getElementsByClassName("layui-table-header")                   
                /*
                    第二步 遍历节点数组
                */
                for(var i=0;i<luckElements.length;i++){
                    //获取元素的value值
                   // alert(luckElements[i].value);
                    //获取元素的type值
                   // alert(luckElements[i].type);
                    //为每一个元素的onclick属性赋值即为文本框增加点击事件
                    luckElements[i].onclick=function(){
			             setTimeout(function() {
			            	 // 获取当前页面做拼接
			            	  
			            	 var checkStatus = table.checkStatus("tableAll");    	                 			  
                				var ids = "";
                            	var idList = "";
                            	var dataList = checkStatus.data;
                            	//console.log(dataList);
                            	$.each(dataList, function(i, data) {
                            		//console.log(data.id);
                            	    ids = ids +","+ data.id;
                            	   idList = idList +","+ data.id+"_"+data.roleStatus+"_"+data.menuRoleId+"_";
                            	});
                            	chakAdd(page,ids,idList)
			             },  500);	
                    }
                }
        
        var main =  document.getElementsByClassName("layui-table-body layui-table-main")
                for(var i=0;i<main.length;i++){                        
		              main[i].onclick=function(){
       	 			//console.log("fhu");
		            	 setTimeout(function() {
		            		
			            	 var checkStatus = table.checkStatus("tableAll");    
		         			  
		         				var ids = [];
		                     	
		                     	var dataList = checkStatus.data;
		                     	//console.log(dataList);
		                     	$.each(dataList, function(i, data) {
                            		//console.log(data.id);
                            	    ids.push(data.id);
                            		
                            	});
                            	chakAdd(page,ids)
			             },  100);	
            			}
                }
        
        // 绑定分页
        var table_page =  document.getElementsByClassName("layui-table-page")
                for(var i=0;i<table_page.length;i++){                       
		              table_page[i].onclick=function(){
       	 				// 给点击页给值 
       	 				page = $("#pageId").val();
       	 				//console.log(page);
		            	 setTimeout(function() {
		            		 // 设置选中项
		            		 chak();
			             },  100);	
            			}
                }
        
    	layer.close(loadi);
		return false;  
    } 
    
    /*任务-添加*/
    function member_RoleStatus(Object,id){  // 用id 
    	
        layer.confirm('确认要添加吗？Id为:'+id,function(index){
        	addTasks(id);
        });
    }
	function addTasks(id){
		var loadi = layer.load('加载中......');

		 //发异步                         
        var url = "add/TaskRecordAddTask";  
        var data ={
        		userId:id,        		
        		taskId:getTaskId()
            }; 
       
        $.ajax({
    		url:url,
    		data:data,
    		type:'post',
    		dataType:'json',
    		success: function(result){
    			//console.log(result.code);
    			
                	layer.close(loadi);
    			if(result.code==200){  
    				layer.msg('添加成功', {icon: 1});
    			}else{
    				layer.alert(result.msg, {
                        icon: 7
                    });
    			}
    			
    		},
    		error: function(e){
    			//alert("通信失败!");
    		}
    	});
        return false;
	}
	
	// 获取缓存数据
	function getTaskId(){

		var taskId =0;
		if(localStorage.getItem("id")!=null){	
			if(getUrlParam("id")!=null && getUrlParam("id")!=""){
				localStorage.setItem('id',getUrlParam("id")); // 存入
			}
			taskId =localStorage.getItem("id") // 取出
        }else{
        	localStorage.setItem('id',getUrlParam("id")); // 存入
        }
		//console.log(taskId +"qqwqwqw");
		return taskId;
	}
	
	 //保存选中值
    function chakAdd(page,ids){
    	var curren = page+"-0,";
    	var currens = page+"-1,";
    	if(idlength.indexOf(curren) != -1){
    		// 组数据
    		
    		  var index_1 = idlength.indexOf(curren);	
    		  
    		  var index_2 = idlength.indexOf(currens) + currens.length;	
    		  
    		  var test = idlength.slice(index_1, index_2) //得到已有字段
    		  
    		  idlength = idlength.replace(test, ""); //删除己有字段，
    		  idlength = idlength +curren+ ids.toString()+","+currens; // 重新添加

    	}else{
    		
    		idlength = idlength +curren+ ids.toString()+","+currens;
    	}
    	
    }
	
    // 默认选中
    function chak(){
    	//获取下面所有的复选框
        var str = idlength.split(",");
        //console.log(str);
        if(idlength!=null && idlength!=""){
        	
                //拿到每一个复选框，并将其状态置为选中           	
                //checkOnes[i].checked=false;
                for(var a= 0 ;str.length>a;a++){
           			if(str[a]!=null && str[a]!=""){
           				
           				if(str[a].indexOf("-") == -1){
           				console.log("strId="+str[a]);
           					var td = $('#LAY_table_user').next().find('.layui-table-box tr td[data-content="'+str[a]+'"]  input');//...
               			    td.next().click();
           				}
           				
           				
           			 
           			}
                }

        }
       
    }
    </script>
        
    <!--  <script>var _hmt = _hmt || []; (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?b393d153aeb26b46e9431fabaf0f6190";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script>-->

</html>
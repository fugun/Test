<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title> 任务管理</title>
    <meta http-equiv="content-type" content="text/html; charset=GBK" />
    <meta name="keywords" content="任务管理" />
    <meta name="description" content="任务管理" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="res/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="res/assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <link rel="stylesheet" href="res/assets/bootstrap-toggle-buttons/static/stylesheets/bootstrap-toggle-buttons.css" />
    <link href="res/css/style.css" rel="stylesheet" />
    <link href="res/css/chosen.css" rel="stylesheet" />
    <script type="text/javascript" src="res/js/updateimg.js" ></script>
</head>

<body class="fixed-top">
    <div class="container-fluid container-fluid-back">
        <!-- BEGIN PAGE HEADER-->
        <div class="row-fluid">
            <div class="span12">
                <!-- BEGIN PAGE TITLE & BREADCRUMB-->
                <ul class="breadcrumb">
                    <li><a href="/right.jsp">首页</a> <span class="divider">/</span></li>
                    <li><a href="#">任务管理中心</a> <span class="divider">/</span></li>
                    <li class="active">任务管理</li>
                </ul>
                <!-- END PAGE TITLE & BREADCRUMB-->
            </div>
        </div>
        <!-- 开始:列表-->
        <div id="page-wraper">
        </div>
        <!-- huadongm-->
        <div class="Main">
            <div id="divMainTab" class="MainTab">
                <ul class="huadm">
                    <li id="li_1" class="selected" onClick="changeTab('1')"><i ></i>查询</li>
                    <li id="li_2" class="normal" onClick="changeTab('2')"><i ></i>新增</li>
                </ul>
            </div>
            <div id="div1" style="display :block" class="divContent">
                <!-- BEGIN BASIC PORTLET-->
                <div class="widget green" id="sms_channel_list">
                    <div class="widget-title">
                        <span class="tools">
                        <a href="javascript:;" class="icon-chevron-down"></a>
                        <a href="javascript:;" class="icon-remove"></a>
                    </span>
                    </div>
                    <div class="widget-body">
                      <!-- BEGIN FORM-->
                        <form action="#" class="form-horizontal1">
                            <div class="control-group sp_group">
                                <label class="sp-labe2">任务类型：</label>

                                <div class="controls sp-xiala">
                                    <select class="spanr6 chzn-select" id="sms_channelType" style="width:60px;" data-placeholder="" tabindex="1">
                                        <option value="" selected="selected">请选择</option>
                                        <option value="">**</option>
                                        <option value="1">**</option>
                                        <option value="2">**</option>
                                    </select>
                                </div>                                
                                <label class="sp-labe2">根据广告主查找：</label>

                                <div class="controls controlsw">
                                    <input type="text" id="sms_port" class="spannr6 " />
                                </div>
                                <label class="sp-labe2">>根据关键字查找：</label>

                                <div class="controls controlsw">
                                    <input type="text" id="sms_cmd" class="spannr6" />
                                </div>
                                <label class="sp-labe2">状态：</label>

                                <div class="controls sp-xiala">
                                    <select class="spanr6 chzn-select" id="sms_status" style=" width:73px;" data-placeholder="" tabindex="1">
                                        <option value="" selected="selected">请选择</option>
                                        <option value="1">正常</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                                <button class="btn btncha" onclick="query(1)" type="button"><i></i>查询</button>
                            </div>
                            <table id="accountTypeList" class="table table-striped table-hover table-bordered">
                                <thead>
                                    <tr>
                                       <th>标题</th>
                                        <th>任务描述</th>
                                        <th>任务日期</th>
                                        <th>添加时间</th>                                       
                                        <th>添加人用户id</th>
                                        <th>状态</th>
                                        <th>任务类型</th> 
                                        <th>编辑</th>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                            <div class="pagination fenye" id="sms_page_list">
                                <ul>
                                </ul>
                            </div>
                        </form>
                        <!-- END FORM-->
                    </div>
                </div>
                <!-- END BASIC PORTLET-->
            </div>
            <div id="div2" style="display:none;" class="divContent">
                <!-- BEGIN BASIC PORTLET-->
                <div class="widget purple">
                        <div class="widget-title">
                            <span class="tools">
                        <a href="javascript:;" class="icon-chevron-down"></a>
                        <a href="javascript:;" class="icon-remove"></a>
                    </span>
                        </div>
                        <div class="widget-body">
                            <!-- BEGIN FORM-->
                            <div class="tongdao">
                                <div class="row-fluid">
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <div class="control-group">
                                                <label class="control-label tongdaoming">任务标题:</label>

                                                <div class="controls controlsw">
                                                    <input id="Title" type="text" class="spann6 " />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="span6">
                                            <label class="sp-label">任务类型：</label>

                                            <div class="controls sp-xiala">
                                                <select class="span6 chzn-select" style="width:100px;" id="Type" data-placeholder="" tabindex="1">
                                                    <option value="" selected="selected">请选择</option>
                                                    <option value="0">朋友圈任务</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <div class="control-group">
                                                <label class="control-label tongdaoming">普通会员：</label>

                                                <div class="controls controlsw">
                                                    <input id="Reward" type="text" class="spann6 " />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="span6">
                                            <div class="control-group groupge">
                                                <label class="control-label tongdaoming">黄金 VIP：</label>

                                                <div class="controls controlsw">
                                                    <input type="text" class="wenbenyu" id="RewardVip1" />
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row-fluid">
                                       <div class="span6">
                                            <div class="control-group">
                                                <label class="control-label tongdaoming">钻石VIP：</label>

                                                <div class="controls controlsw">
                                                    <input id="RewardVip2" type="text" class="spann6 " />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="span6">
                                            <label class="sp-label">状态：</label>

                                            <div class="controls">
                                                <div id="sms-status-normal-toggle-button">
                                                    <input type="checkbox" id="Status" checked="checked" />
                                                </div>
                                            </div>
                                        </div>
                                             
                                    </div>                                 
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <label class="sp-label">任务日期：</label>

                                            <div class="controls">
                                                <input type="text" class="span6" id="date" />
                                            </div>
                                        </div>
                                        <!-- <div class="span6">
                                            <label class="sp-label">下发佣金：</label>

                                            <div class="controls">
                                                <input type="text" class="span6" id="smsMonthlyNumber" />
                                            </div>
                                        </div> -->
                                    </div> 
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <label class="sp-label">任务说明/下发：</label>

                                            <div class="controls">
                                                <textarea id="Description" multiple="multiple" class="wenbxa"></textarea>
                                            </div>
                                        </div>
                                        <div class="span6">
                                            <div class="control-group groupge">
                                               <div id="showimg">
													<ul id="showui">
													</ul>
									
													<div id="showinput">
									
													</div>
												</div>
												<div class="upimg">
													<input type="file" id="upgteimg" value="" multiple />
												</div>
									
												<button class="btn yans1" id="submit">开始上传</button>
												 <input type="hidden" id="img_url" name="img" value=""/>												
											</div>
 
                                        </div>              
                                    </div>
                                </div>

                            </div>
                            <div class="form-actions actionsbao">
                                <button type="submit" onclick="saveEdit()" class="btn yans1">编辑/保存</button>
                                <button type="button" class="btn" onclick="emptyEdit()">取消</button>
                            </div>
                            <!-- END FORM-->
                        </div>
                    </div>
                
                <!-- END BASIC PORTLET-->
            </div>
        </div>
        <!-- huadongm-->
        <!-- 结束:列表-->
        <!-- 开始:通道接入类型-->
        <div id="page-wraper">
        </div>
        <!-- 结束:通道接入类型-->
    </div>
    <script src="res/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="res/js/jquery.nicescroll.js"></script>
    <script type="text/javascript" src="res/js/chosen.jquery.min.js"></script>
    <script type="text/javascript" src="res/assets/bootstrap-toggle-buttons/static/js/jquery.toggle.buttons.js"></script>
    <script src="res/js/common-scripts.js"></script>
    <script src="res/js/form-component.js"></script>
    <script src="res/js/layer.min.js" type="text/javascript"></script>
    <script src="res/js/onion_news_comment.js" type="text/javascript"></script>
    <script language="javascript" type="text/javascript">
        //<![CDATA[
        $(document).ready(function() {
            //querySpComplaySelectStatusTrue();
            // querySmsChannels(1);


            $('#sms-status-normal-toggle-button').toggleButtons({
                label: {
                    enabled: "正常",
                    disabled: "禁用"
                }
            });
            $("#ivr-status-normal-toggle-button").toggleButtons({
                label: {
                    enabled: "正常",
                    disabled: "禁用"
                }
            });
        });

       

        function query(currentPage) {
            var sms_load = layer.load("正在努力加载中..");
            var sms_page_url = "query";
            $.post(
                sms_page_url, {
                    currentPage: currentPage,
                    providerId: $("#sms_channelType").val(),
                    spId: $("#sms_sp_complay").val(),
                    port: $("#sms_port").val(),
                    cmd: $("#sms_cmd").val(),
                    channelStatus: $("#sms_status").val()
                },
                function(data) {
                	
                    layer.close(sms_load);
                    $("#sms_channel_list .widget-body table tbody").empty();
                    switch (data.code) {
                        case 1:
                            var smsChannels = data.data;
                            var tbodyHtml = "";
                            $.each(smsChannels, function(i, smsChannel) {
                                var status = "启用";
                                if (smsChannel.channelStatus == 0) {
                                    status = "禁用";
                                }
                                var isContentDim="";
                                if(smsChannel.isContentDim==1){
                                    isContentDim="指令模糊";
                                }else{
                                    isContentDim="精确";
                                }
                               
                                tbodyHtml = tbodyHtml + "<tr class=\"\">";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.title  + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.description + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.taskDate + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.addTime + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.addUserId + "</td>";
                                /* tbodyHtml = tbodyHtml + "	<td class=\"center\">" + smsChannel.channelPort + "</td>";
                                tbodyHtml = tbodyHtml + "	<td class=\"daokuang\">" + smsChannel.channelContent + "</td>";
                                tbodyHtml = tbodyHtml+"<td>"+isContentDim+"</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.channelPrice + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + smsChannel.dividedPrice + "</td>"; */
                                if (smsChannel.status == 1) {
                                    tbodyHtml = tbodyHtml + "	<td><span class=\"label label-important label-mini\">正常</span></td>";
                                } else {
                                    tbodyHtml = tbodyHtml + "    <td><span class=\"label label-import label-mini\">关闭</span></td>";
                                }
                                if (smsChannel.type == 0) {
                                    tbodyHtml = tbodyHtml + "	<td><span class=\"label label-important label-mini\">朋友圈任务</span></td>";
                                } else {
                                    tbodyHtml = tbodyHtml + "    <td><span class=\"label label-import label-mini\">其它</span></td>";
                                }
                                tbodyHtml = tbodyHtml + "	<td><span  class=\"btn btncha\" type=\"button\" onclick=\"edit(" + smsChannel.taskId + ")\"><i class=\"icon-share-alt\"></i>编辑</span></td>";
                                tbodyHtml = tbodyHtml + "</tr>";
                            });
                            $("#sms_channel_list .widget-body table tbody").html(tbodyHtml);
                            $("#sms_page_list").html(pageText(data.pageModel, 'query'));
                            break;
                        case -1:
                            layer.alert("载入失败!请刷新重试", 3, !1);
                            break;
                        default:
                            break;
                    }
                }, "json"
            );
        }

      
        function edit(id) {
            var url = "taskId";
            console.log(id);
            $.post(
                url, {
                    id: id
                },
                function(data) {
                    var tasks = data.data;
                    console.log(tasks);
                    $.each(tasks, function(i, task) {
	                    switch (data.code) {
	                        case 1:
	                            $("#Title").val(task.title);
	                            $("#Description").val(task.description);
	                            $("#Reward").val(task.Reward);
	                            $("#RewardVip2").val(task.rewardVip2);
	                            $("#RewardVip1").val(task.rewardVip1);
	                            $("#date").val(task.date);
	                            if (task.status == 1) {
	                                $('#status').prop('checked', true).change();
	                            } else {
	                                $('#status').prop('checked', false).change();
	                            }
	                        
	                            $(".chzn-select").trigger("liszt:updated");
	                            break;
	                        case 0:
	                            layer.alert("系统错误!请刷新重试或者联系管理员.", 3, !1);
	                            break;
	                        default:
	                            break;
	                    }
                    });
                }, "json"
            );
        }
		
        //取消
        function emptyEdit(){
        	
        	 $("#Title").val("");
             $("#Type").val("");
             $("#Description").val("");
             $("#img_url").val("");
             $("#Reward").val("");
             $("#RewardVip1").val("");
             $("#RewardVip2").val("");
             $("#Status").val("");  
        }
        
        function saveEdit() {
        	var sms_load = layer.load("保存中..");
            var title = $("#Title").val();
            var type = $("#Type").val();
            var descRiption = $("#Description").val();
            var imgUrl = $("#img_url").val();
            var reward = $("#Reward").val();
            var rewardvip1 = $("#RewardVip1").val();
            var rewardVip2 = $("#RewardVip2").val(); 
            var TaskStatus = $("#Status").is(":checked") ? 1 : 0;
            var date = $("#date");
            
            var Status = TaskStatus;
          
            if (title.length < 1) {
                layer.alert("请输入标题!\n Error:标题不能为空!", 3, !1);
                return false;
            }
            
            if (img_url=="0") {
                layer.alert("请上传图片!!", 3, !1);
                return false;
            }
            

            if (!$('#Status').is(":checked")) {
            	Status = 0;
            }

            var save_task_url = "saveTask";
	        var data ={
	        		title: title,
                	type: type,
                	descRiption: descRiption,
                	imgUrl: imgUrl,
                	reward: reward,
                	rewardvip1: rewardvip1,
                	rewardVip2: rewardVip2,
                	Status: Status   
	            };            
	        $.ajax({
	    		url:save_task_url,
	    		data:data,
	    		type:'post',
	    		dataType:'json',
	    		success: function(result){
	    			console.log(result);
	    			switch (result.code) {
                    case 1:
                        layer.alert("新增任务成功!", 1, !1);
                        emptyEdit();
                        break;
                    case 2:
                        layer.alert("新增任务成功发生错误!请重试或联系管理员.", 3, !1);
                        break;                      
                    default:
                        break;
                	}
	    		},
	    		error: function(e){
	    			alert("通信失败!");
	    			
	    		}
	        });
        }

        //获取IVR通道分页
        function queryIvrChannels(currentPage) {
            var ivr_load = layer.load("正在努力加载IVR通道中..");
            var complay = $("#ivr_complay").val();
            var port = $("#ivr_port").val();
            var channelStatus = $("#ivr_channel_status").val();
            var url = "/sp/channel/queryIvrChannels";
            $.post(
                url, {
                    currentPage: currentPage,
                    spId: complay,
                    port: port,
                    channelStatus: channelStatus,
                },
                function(data) {
                    layer.close(ivr_load);
                    $("#ivr_channel_list .widget-body table tbody").empty();
                    switch (data.code) {
                        case 1:
                            var ivrChannels = data.data.content;
                            var tbodyHtml = "";
                            $.each(ivrChannels, function(i, ivrChannel) {
                                var status = "启用";
                                if (ivrChannel.channelStatus == 0) {
                                    status = "禁用";
                                }
                                tbodyHtml = tbodyHtml + "<tr class=\"\">";
                                tbodyHtml = tbodyHtml + "	<td>" + ivrChannel.channelName + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + ivrChannel.spInfo.companyName + "</td>";
                                tbodyHtml = tbodyHtml + "	<td class=\"center\">" + ivrChannel.channelPort + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + ivrChannel.channelPrice + "</td>";
                                tbodyHtml = tbodyHtml + "	<td>" + ivrChannel.dividedPrice + "</td>";
                                if (ivrChannel.channelStatus == 1) {
                                    tbodyHtml = tbodyHtml + "	<td><span class=\"label label-success label-mini\">" + status + "</span></td>";
                                } else {
                                    tbodyHtml = tbodyHtml + "	<td><span class=\"label label-important label-mini\">" + status + "</span></td>";
                                }

                                tbodyHtml = tbodyHtml + "	<td><button class=\"btn btncha\" type=\"button\" onclick=\"editIvrChannel(" + ivrChannel.id + ")\">编辑</button></td>";
                                tbodyHtml = tbodyHtml + "</tr>";
                            });
                            $("#ivr_channel_list .widget-body table tbody").html(tbodyHtml);
                            $("#ivr_page_list").html(pageText(data.data, 'queryIvrChannels'));
                            break;
                        case 1:
                            layer.alert("SP公司列表载入失败!请刷新重试", 3, !1);
                            break;
                        default:
                            break;
                    }
                }, "json"
            );
        }
		//取消 -
      function  emptySaveIvrChannel(){
    	  ivrClear();
    	   $("#ivrChannel").empty();
           $("#ivrChannelComplay").val("");
           $("#ivrChannelName").val("");
           $("#ivrChannelPort").val("");
           $("#ivrChannelMoney").val("");
           $("#ivrChannelDivided").val("");
           $("#ivrChannelGateway").val("");
           $("#ivrDayNumber").val("");
           $("#ivrMonthlyNumber").val("");
           $("#ivrSummary").val("");
      }
        //编辑=保存IVR通道
        function editSaveIvrChannel() {
            var ivrChannel = $("#ivrChannel").val();
            var ivrChannelComplay = $("#ivrChannelComplay").val();
            var ivrChannelName = $("#ivrChannelName").val();
            var ivrChannelPort = $("#ivrChannelPort").val();
            var ivrChannelMoney = $("#ivrChannelMoney").val();
            var ivrChannelDivided = $("#ivrChannelDivided").val();
            var ivrChannelGateway = $("#ivrChannelGateway").val();
            var ivrDayNumber = $("#ivrDayNumber").val();
            var ivrMonthlyNumber = $("#ivrMonthlyNumber").val();
            var ivrSummary = $("#ivrSummary").val();
            if (ivrChannelComplay == 0) {
                layer.alert("请选择通道所属SP公司!\n Error:通道所属SP公司不能为空!", 3, !1);
                return false;
            }

            if (ivrChannelName.length < 1) {
                layer.alert("请填写通道名称!\n Error:通道名称不能为空!", 3, !1);
                return false;
            }
            if (ivrChannelPort.length < 1) {
                layer.alert("请填写通道端口!\n Error:通道端口不能为空!", 3, !1);
                return false;
            }
            if (ivrChannelMoney.length < 1) {
                layer.alert("请填写通道资费!\n Error:通道资费不能为空!", 3, !1);
                return false;
            }
            if(parseInt(ivrChannelMoney)!=ivrChannelMoney){
                layer.alert("请填写通道资费!\n Error:通道资费单位为分,请不要输入小数!", 3, !1);
                return false;
            }
            if (ivrChannelDivided.length < 1) {
                layer.alert("请填写通道分成!\n Error:通道分成不能为空!", 3, !1);
                return false;
            }
            if(parseInt(ivrChannelDivided)!=ivrChannelDivided){
                layer.alert("请填写通道分成!\n Error:通道分成单位为分,请不要输入小数!", 3, !1);
                return false;
            }

            if (ivrChannelGateway == -1) {
                layer.alert("请选择网关类型!\n Error:运营商不能不选择!", 3, !1);
                return false;
            }
            var channelStatus = 1;
            if (!$('#ivrChannelStatus').is(":checked")) {
                channelStatus = 0;
            }

            var save_channel_url = "/sp/channel/saveEditIvrChannel";
            $.post(
                save_channel_url, {
                    ivr_channel: ivrChannel,
                    ivr_complay: ivrChannelComplay,
                    ivr_channelName: ivrChannelName,
                    ivr_channelPort: ivrChannelPort,
                    ivr_channelMoney: ivrChannelMoney,
                    ivr_channelDivied: ivrChannelDivided,
                    ivr_channelGateway: ivrChannelGateway,
                    ivr_channelStatus: channelStatus,
                    ivr_dayNumber: ivrDayNumber,
                    ivr_monthNumber: ivrMonthlyNumber,
                    ivr_summary: ivrSummary,
                },
                function(data) {
                    switch (data.code) {
                        case 1:
                            ivrClear();
                            queryIvrChannels(1);
                            layer.alert("保存IVR通道成功!", 1, !1);
                            break;
                        case 2:
                            layer.alert("保存通道发生错误!请重试或联系管理员.", 3, !1);
                            break;
                        case 3:
                            layer.alert("保存通道失败!不是您的上家.", 3, !1);
                            break;
                        case 4:
                            layer.alert("保存通道失败!通道名称已存在.", 3, !1);
                            break;
                        case 5:
                            layer.alert("保存通道失败!端口指令已存在.", 3, !1);
                            break;
                        default:
                            break;
                    }
                }, "json"
            );
            return false;

        }



        //]]>
    </script>
</body>

</html>
